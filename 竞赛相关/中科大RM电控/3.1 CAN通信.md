# 3.1 CAN通信

## 何为CAN总线

多电控单元间交换数据使用的**多主机局部网络串行通信协议**

总的来说，就是一条通信线路上连接多个节点，各个节点都通过这条线路来发送信息，当一个节点发送消息时，其他节点监听；当多个节点发送消息是，按照优先级发送。

可实现 点对点，点对多点，全局广播的功能。
$$
一般认为有两个层级
\begin{cases}
		数据链路层 \\
		物理层\\
	\end{cases}
$$

## 数据格式

### 帧类型

#### 数据帧

数据帧包含以下部分

- 帧起始（SOF）：单个显性位组成，总线空闲时，发送节点发送帧起始。其他节点同步于该帧起始位
- 仲裁域：决定发送优先级
  - ID：顾名思义，所发送数据的身份标识，大小为11字节。
  - SRR：替代远程帧请求位，为显性
  - IDE：识别符扩展位，在整个数据格式中处于第14位。在标准帧格式中位于控制域，为显性；在扩展帧格式中位于仲裁域，为隐性
  - RTR：远程帧发送标识位，为显性

- 控制域
  - IDE：已在仲裁域中解释过，不再赘述
  - r0, r1：保留位0和1，在目前的CAN总线规范中没有明确定义用途。一般用于隐性电平填充。
  - DLC：数据段长度码；BCD编码，范围0~8

- 数据域：MSB优先传输
- CRC域：数据检错，CRC校验值存放于CRC段
- 应答域（ACK）：帧起始到CRC段之间的内容没有错误，则在ACK段发送显性电平
  - ACK槽：发送节点发送隐性电平；接收正确的节点发送显性电平 → 总线与结果为显性电平。发送节点据此可判断发送成功
  - ACK界定符：1个隐性电平

- 帧结尾（EOF）：7个连续隐性位组成

相信上述内容有许多专有名词难以理解，这些内容将在文末进行阐释。

**标准帧格式** 如下

<table>
<tr>
<th> </th>
<th>帧起始</th>
<th colspan=2>仲裁域</th>
<th colspan=3>控制域</th>
<th>数据域</th>
<th colspan=2>CRC域</th>
<th colspan=2>ACK域</th>
<th>帧结束</th>
</tr>
<tr>
<th>组成部分</th>
<td>SOF</td>
<td>ID[0:10]</td>
<td>RTR</td>
<td>IDE</td>
<td>r0</td>
<td>DLC</td>
<td>Data:Byte0~Byte7</td>
<td>CRC_Value[0:14]</td>
<td>CRC界定符</td>
<td>ACK槽</td>
<td>ACK界定符</td>
<td>EOF</td>
</tr>
<tr>
<th>数据大小/bit</th>
<td>1</td>
<td>11</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>4</td>
<td>0~64</td>
<td>15</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>7</td>
</tr>    
</table>

**扩展帧格式** 较 **标准帧格式** 有如下区别

<table>
<tr>
<th> </th>
<th>...</th>
<th colspan=5>仲裁域</th>
<th colspan=3>控制域</th>
<th>...</th>
</tr>
<tr>
<th>组成部分</th>
<td>...</td>
<td>ID[0:10]</td>
<td>SRR</td>
<td>IDE</td>
<td>ID[11,28]</td>
<td>RTR</td>
<td>r1</td>
<td>r0</td>
<td>DLC</td>
<td>...</td>
</tr>
<tr>
<th>数据大小/bit</th>
<td>...</td>
<td>11</td>
<td>1</td>
<td>1</td>
<td>18</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>4</td>
<td>...</td>
</tr>
</table>

#### 远程帧

与数据帧相比，远程帧无数据域，由6个部分组成，也有标准格式和扩展格式，且RTR为1（隐性电平）。

**标准帧格式** 如下

<table>
<tr>
<th> </th>
<th>帧起始</th>
<th colspan=2>仲裁域</th>
<th colspan=3>控制域</th>
<th colspan=2>CRC域</th>
<th colspan=2>ACK域</th>
<th>帧结束</th>
</tr>
<tr>
<th>组成部分</th>
<td>SOF</td>
<td>ID[0:10]</td>
<td>RTR</td>
<td>IDE</td>
<td>r0</td>
<td>DLC</td>
<td>CRC_Value[0:14]</td>
<td>CRC界定符</td>
<td>ACK槽</td>
<td>ACK界定符</td>
<td>EOF</td>
</tr>
<tr>
<th>数据大小/bit</th>
<td>1</td>
<td>11</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>4</td>
<td>15</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>7</td>
</tr>    
</table>

**扩展帧格式** 较 **标准帧格式** 有如下区别

<table>
<tr>
<th> </th>
<th>...</th>
<th colspan=5>仲裁域</th>
<th colspan=3>控制域</th>
<th>...</th>
</tr>
<tr>
<th>组成部分</th>
<td>...</td>
<td>ID[0:10]</td>
<td>SRR</td>
<td>IDE</td>
<td>ID[11,28]</td>
<td>RTR</td>
<td>r1</td>
<td>r0</td>
<td>DLC</td>
<td>...</td>
</tr>
<tr>
<th>数据大小/bit</th>
<td>...</td>
<td>11</td>
<td>1</td>
<td>1</td>
<td>18</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>4</td>
<td>...</td>
</tr>
</table>
#### 数据帧与远程帧的区别

| 比较内容    | 数据帧                      | 远程帧               |
| ----------- | --------------------------- | -------------------- |
| ID          | 发送节点的ID                | 被请求发送节点的ID   |
| SRR         | 0（显性电平）               | 1（隐性电平）        |
| RTR         | 0（显性电平）               | 1（隐性电平）        |
| DLC         | 发送数据长度                | 请求的数据长度       |
| 有无数据段  | 有                          | 无                   |
| CRC校验范围 | 帧起始+仲裁域+控制域+数据域 | 帧起始+仲裁域+控制域 |

#### 错误帧

CAN-bus 错误类型

- CRC错误：发送节点计算得到的CRC值与接收到的CRC值不匹配
- 格式错误：传输的数据帧格式与任何一种合法帧格式不符
- 应答错误：发送节点在ACK阶段没有接收到应答信号
- 位发送错误：发送节点在发送时发现总线电平与发送电平不相同
- 位填充错误：传输信号违反“位填充”规则

当出现以上5种错误类型之一时，发送或接收节点将发送错误帧，结构为 `错误标识 + 错误界定符`

主动错误标识：由处于主动错误状态的节点发送 ↓

<table>
	<tr>
		<th colspan=6>6个连续显性电平位</th>
		<th colspan=8>8个连续隐性电平位</th>
	</tr>
    <tr>
        <td>0</td>
    	<td>0</td>
    	<td>0</td>
    	<td>0</td>
    	<td>0</td>
    	<td>0</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    </tr>
</table>

被动错误标识：由处于被动错误状态的节点发送 ↓

<table>
	<tr>
		<th colspan=6>6个连续隐性电平位</th>
		<th colspan=8>8个连续隐性电平位</th>
	</tr>
    <tr>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    </tr>
</table>

为防止无法正常接收的节点一直发送错误帧干扰通信，CAN-bus规定了节点的三种状态及行为

- REC：接收错误计数器

- TEC：发送错误计数器

复位时二者都被清零

![CAN-bus_node_states](E:\Git\LinhoNotes\Public\Image\CAN-bus_node_states.png)

#### 过载帧

当某接收节点没有做好接受下一帧数据准备时，将发送过载帧来通知发送节点

过载帧结构 `过载标志 + 过载帧界定符`

<table>
	<tr>
		<th colspan=6>6个连续显性电平位（过载标志）</th>
		<th colspan=8>8个连续隐性电平位（过载帧界定符）</th>
	</tr>
    <tr>
        <td>0</td>
    	<td>0</td>
    	<td>0</td>
    	<td>0</td>
    	<td>0</td>
    	<td>0</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    	<td>1</td>
    </tr>
</table>

由于存在多个节点同时过载且过载帧发送有时间差，可能出现叠加超6个位的情况

![Can-bus_overload](E:\Git\LinhoNotes\Public\Image\Can-bus_overload.png)

#### 帧间隔

用于将数据帧或远程帧和他们之前的帧分开，但过载帧和错误帧前不会插入帧间隔

<table>
<tr>
    <td>...</td>
	<td>其他帧</td>
	<td>帧间隔</td>
	<td>数据帧或远程帧</td>
	<td>...</td>
	<td>其他帧</td>
	<td>数据帧或远程帧</td>
	<td>...</td>
</tr>
</table>
- 帧间隔过后，若无节点发送帧则总线进入空闲

<table>
<tr>
    <td>...</td>
	<td>帧间隔</td>
	<td>0~∞</td>
	<td>...</td>
</tr>
</table>

- 帧间隔过后，如果被动错误节点要发送帧，则先发送8个隐性电平的传输延迟，再发送帧

<table>
<tr>
    <td>...</td>
	<td>帧间隔</td>
	<td>传输延迟（8个隐性位）</td>
    <td>被动错误节点发送帧</td>
	<td>...</td>
</tr>
</table>

> [!warning]
>
> 保证主动错误节点优先发送，避免被动错误节点因硬件故障干扰整个网络

## 一些疑惑及解答

*何为显性电平？何为隐性电平？[2]*

**答：**显性电平在逻辑层面表现为0，隐性电平在逻辑层面表现为1；显性电平覆盖隐性电平；均为隐性电平时总线上才为隐性电平。CAN采用差分电压发送电平（ `Vdiff` ） `V_diff = CAN_H - CAN_L`

**典例** CAN总线为“隐性”（逻辑1）时，CAN_H和CAN_L的电平为2.5V（电位差V_diff为0V）

**图解**

![CAN_Bus_Line](E:\Git\LinhoNotes\Public\Image\CAN_Bus_Line.png)

![CAN_electrical_level](E:\Git\LinhoNotes\Public\Image\CAN_electrical_level.png)



*CAN通信采用双绞线传输的优点？*

**答：**使外部干扰在两根导线上产生的噪声相同，以便后续的差分电路提取出有用信号



*仲裁域如何实现仲裁功能？*

**答：**CAN控制器在发送数据的同时监测数据线的电平是否与发送数据对应电平相同，如果不同则停止发送并做其他处理 ↓

1. 如果该位处于仲裁域，则退出总线竞争
2. 如果处于其他域，则产生错误时间（ACK或被动错误标志传输期间除外）

简而言之，显性电平覆盖隐性电平。同一位电平不相同时，显性电平继续发送，隐性电平的进入只听模式



*数据帧与遥控帧的优先级*

**答：**数据帧优先级>遥控帧优先级，因为数据帧仲裁段RTR为显性



*标准格式与扩展格式的优先级*

**答：**标准格式优先级>扩展格式优先级，因为标准格式IDE位为显性电平，扩展格式IDE位为隐性电平。

> [!warning]
>
> 对于前11位ID相同的标准格式和扩展格式才适用于此规则，前11位ID不相同的适用于仲裁规则



*r0, r1作用？什么是隐性电平填充？[3]*

**答：**r0与r1为保留位，在当前的CAN标准中，这些位的具体用途并未明确定义。之所以用于隐性电平填充是因为 数字越大优先级越小，若为1（即隐性电平）则永远不会用得到它。



*BCD编码？*



*什么是MSB数据？*



*CRC如何计算？*



*何为主动错误状态？何为被动错误状态？*



*主动错误和过载帧报文一致，如何区分？*



*CSMA/CD协议*

此部分内容较长，单开一节讲起

## 参考资料

[1] [图解CAN总线数据的组成和帧格式_can总线帧头-CSDN博客](https://blog.csdn.net/LEON1741/article/details/106199472)

[2] [CAN总线电平（隐性与显性）_can显性和隐性电平-CSDN博客](https://blog.csdn.net/skyxiao/article/details/116116018)

[3] [CAN总线基础（2）--数据帧深层解析_can数据帧-CSDN博客](https://blog.csdn.net/kian9one/article/details/139899769)